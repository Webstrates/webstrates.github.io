<!doctype html>
<html>
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Creating a module | Webstrates</title>
	<meta name="description" content="A research prototype enabling collaborative editing of websites through DOM manipulations.">
	<link rel="stylesheet" href="/css/syntax.css">
	<link rel="stylesheet" href="/css/main.css">
</head>
<body>
	<div id="container">
		<header>
			<h1>
				<a class="brand" href="/">Webstrates</a>
				<small>A research prototype enabling collaborative editing of websites through DOM manipulations.</small>
			</h1>
		</header>
		<main>
			<div id="navigation">
				<ul class="nav nav-list">
					<li class="home"><a href="/">Home</a></li>
					<li>
						<a class="nav-header" href="">Getting started</a>
						<ul>
							<!--li><a href="/gettingstarted/motivation.html">Motivation</a></li-->
							<li><a href="/gettingstarted/installation.html">Installation</a></li>
							<li><a href="/gettingstarted/hello-world.html">Hello, world</a></li>
							<li><a href="/userguide/tutorials.html">Tutorials</a></li>
						</ul>
					</li>
					<li>
						<a class="nav-header" href="">User guide</a>
						<ul>
							<li><a href="/userguide/api.html">API</a></li>
							<li>
								<ul>
									<li><a href="/userguide/api/events.html">Events</a></li>
									<li><a href="/userguide/api/transient.html">Transient</a></li>
									<li><a href="/userguide/api/cookies.html">Cookies</a></li>
									<li><a href="/userguide/api/assets.html">Assets</a></li>
									<li><a href="/userguide/api/signaling.html">Signaling</a></li>
									<li><a href="/userguide/api/messaging.html">Messaging</a></li>
									<li><a href="/userguide/api/tagging.html">Tagging</a></li>
									<li><a href="/userguide/api/access-tokens.html">Access Tokens</a></li>
									<li><a href="/userguide/api/restore-delete.html">Restore/Delete</a></li>
								</ul>
							</li>
							<li><a href="/userguide/http-api.html">HTTP API</a></li>
							<li><a href="/userguide/server-config.html">Server Config</a></li>
							<li><a href="/userguide/client-config.html">Client Config</a></li>
							<li><a href="/userguide/versioning.html">Versioning</a></li>
						</ul>
					</li>
					<li>
						<a class="nav-header" href="">Developer guide</a>
						<ul>
							<li><a href="/developerguide/introduction.html">Introduction</a></li>
							<li><a href="/developerguide/how-it-works.html">How it works</a></li>
							<li><a class="active" href="/developerguide/creating-a-module.html">Creating a module</a></li>
						</ul>
					</li>
				</ul>
			</div>
			<div id="content">
				<div class="page-header">
					<h1>Creating a module
						
					</h1>
				</div>
				<ul id="markdown-toc">
  <li><a href="#party-module" id="markdown-toc-party-module">Party module</a></li>
  <li><a href="#smash-module" id="markdown-toc-smash-module">Smash module</a></li>
</ul>

<p>It may be useful to expand the functionality of Webstrates with additional client modules; modules that can provide functionality to all webstrates.</p>

<p>Creating a new module can be useful both for providing functionality that is used in many webstrates, lest having to reimplement the same thing over and over.
Modules can also provide new functionality that can’t be implemented solely in client code, either because the module will depend on internal events or it needs to use the websocket, possibly because it needs to handle new kinds of websocket data.
In this case, there is currently no documentation on how to expand the server side code, only the client code.</p>

<p>We’ll now go over two example modules that will demonstrate how to create a module for Webstrates.</p>

<h2 id="party-module">Party module</h2>

<p>They say that “Three’s a party”, so let’s implement a very basic module that creates a global <code class="highlighter-rouge">party</code> event which gets triggered when a third user joins a webstrate.</p>

<p>Modules are located in the <code class="highlighter-rouge">./client/webstrates/</code> folder in the Webstrates installation directory, so let’s start out by creating a new JavaScript file at <code class="highlighter-rouge">./client/webstrates/party.js</code>.</p>

<p>After creating the module file, we need to tell Webstrates to use the module. This is done by adding <code class="highlighter-rouge">'party'</code> to the end of <a href="/userguide/client-config.html#modules">the <code class="highlighter-rouge">modules</code> list in the client configuration <code class="highlighter-rouge">./client/config.js</code></a>.</p>

<p>Our module will need to include two of <a href="/developerguide/introduction.html#list-of-modules">the built-in modules</a>, namely <code class="highlighter-rouge">coreEvents</code> and <code class="highlighter-rouge">globalObject</code>.
We want to listen for the <code class="highlighter-rouge">clientJoin</code> event, so we need <code class="highlighter-rouge">coreEvents</code>. We also need to create a new event on the global object (i.e. <code class="highlighter-rouge">window.webstrate</code>) for which we need the <code class="highlighter-rouge">globalObject</code> module.</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="s1">'use strict'</span><span class="p">;</span>
<span class="kr">const</span> <span class="nx">coreEvents</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./coreEvents'</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">globalObject</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./globalObject'</span><span class="p">);</span>
</code></pre>
</div>

<p>Now, all we need to do is to create the <code class="highlighter-rouge">party</code> event.</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="nx">globalObject</span><span class="p">.</span><span class="nx">createEvent</span><span class="p">(</span><span class="s1">'party'</span><span class="p">);</span>
</code></pre>
</div>

<p>And trigger the event when the number of clients reaches 3:</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="nx">coreEvents</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">'clientJoin'</span><span class="p">,</span> <span class="p">(</span><span class="nx">clientId</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">webstrate</span><span class="p">.</span><span class="nx">clients</span><span class="p">.</span><span class="nx">length</span> <span class="o">===</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">globalObject</span><span class="p">.</span><span class="nx">triggerEvent</span><span class="p">(</span><span class="s1">'party'</span><span class="p">,</span> <span class="nx">clientId</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">});</span>
</code></pre>
</div>

<p>And that’s it. After rebuilding the client application code (by calling <code class="highlighter-rouge">npm run build</code>), the module
will be active and may be used in any webstrate.</p>

<p>Adding the following script to any webstrate will thus cause “Three’s a party” – followed by the joining client’s <code class="highlighter-rouge">clientId</code> – to get printed to the console whenever a third user joins the webstrate.</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="nx">webstrate</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'loaded'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">webstrate</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'party'</span><span class="p">,</span> <span class="p">(</span><span class="nx">clientId</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'Three\'s a party!'</span><span class="p">,</span> <span class="nx">clientId</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">});</span>
</code></pre>
</div>

<h2 id="smash-module">Smash module</h2>

<p>Let’s make it possible to draw attention to a specific <code class="highlighter-rouge">div</code> element in the DOM on other clients.
We’ll do this by allowing users to run <code class="highlighter-rouge">DOMNode.webstrate.smash()</code> on a <code class="highlighter-rouge">div</code> element, and let other clients listen for these smashes with <code class="highlighter-rouge">DOMNode.webstrate.on('smash', fn)</code>.</p>

<p>“Smashing” an element seems very similar to signaling, so we will in fact be building this module on top of signaling.</p>

<p>To create the event, we need to wait for all webstrate objects to have been added, so we again need <code class="highlighter-rouge">coreEvents</code>.
Since we’re building this on top of signaling, we also need the <code class="highlighter-rouge">signaling</code> module.</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="s1">'use strict'</span><span class="p">;</span>
<span class="kr">const</span> <span class="nx">coreEvents</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./coreEvents'</span><span class="p">);</span>
<span class="kr">const</span> <span class="nx">signaling</span> <span class="o">=</span> <span class="nx">require</span><span class="p">(</span><span class="s1">'./signaling'</span><span class="p">);</span>
</code></pre>
</div>

<p>Before we can create the <code class="highlighter-rouge">smash</code> event and <code class="highlighter-rouge">smash()</code> function, we need to wait for the webstrate
objects to get added to the DOM elements.</p>

<p>Once the document has been created initially, and webstrate objects have been added, the <code class="highlighter-rouge">webstrateObjectsAdded</code> event gets triggered with a list of all DOM nodes (and event objects) in the document with webstrate objects on.
When later on, a new element gets added to the document, the <code class="highlighter-rouge">webstrateObjectAdded</code> event gets triggered with the node and event object as well.
Note that the event names differ slightly; the former is plural (Objects) and the latter is singular (Object).</p>

<p>If we listen for these two events, we can thus ensure that our code will get called whenever a webstrate object gets added.</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="nx">coreEvents</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">'webstrateObjectsAdded'</span><span class="p">,</span> <span class="p">(</span><span class="nx">nodes</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">nodes</span><span class="p">.</span><span class="nx">forEach</span><span class="p">((</span><span class="nx">eventObject</span><span class="p">,</span> <span class="nx">node</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">makeSmashable</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">eventObject</span><span class="p">));</span>
<span class="p">},</span> <span class="nx">coreEvents</span><span class="p">.</span><span class="nx">PRIORITY</span><span class="p">.</span><span class="nx">IMMEDIATE</span><span class="p">);</span>

<span class="nx">coreEvents</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">'webstrateObjectAdded'</span><span class="p">,</span> <span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">eventObject</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="nx">makeSmashable</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">eventObject</span><span class="p">);</span>
<span class="p">},</span> <span class="nx">coreEvents</span><span class="p">.</span><span class="nx">PRIORITY</span><span class="p">.</span><span class="nx">IMMEDIATE</span><span class="p">);</span>
</code></pre>
</div>

<div class="info box">
  <h3>What does <code>coreEvents.PRIORITY.IMMEDIATE</code> mean?</h3>
  <p>
    The second argument to <code>coreEvents.addEventListener()</code> is a priority, which determines the order in which the event handlers are triggered.
    This can be useful if, for instance, for one event handler do have finished its job before another event handler can perform its own job.
  </p>
  <p>
    There's a total of 5 priorities, namely <code>IMMEDIATE</code>, <code>HIGH</code>, <code>MEDIUM</code>, <code>LOW</code>, and <code>LAST</code>.
  </p>
  <p>
    Any event handler with <code>IMMEDIATE</code> priority gets executed straight away in the same execution.
    The use of the <code>IMMEDIATE</code> priority should be limited as much as possible, as doing too much work in the same task can cause the browser to become unresponsive.
    However, in this case, we need to run our code immediately, as otherwise clients may attempt to add an event listener for the <code>smash</code> event before it has been created.
  </p>
  <p>
    Event handlers attached with the other 4 priorities are run through <a href="https://developer.mozilla.org/en/docs/Web/API/Window/setImmediate"><code>setImmediate()</code></a> (or <a href="https://developer.mozilla.org/en/docs/Web/API/Window/setTimeout"><code>setTimeout()</code></a> if <code>setImmediate</code> isn't supported by the browser), thus getting executed in their own task.
    Tasks with <code>HIGH</code> priority are the first to be executed (after <code>IMMEDIATE</code>), followed by tasks with <code>MEDIUM</code>, <code>LOW</code>, and finally <code>LAST</code> priorities, respectively. Event handlers added without priority default to <code>LOW</code> priority.
  </p>
</div>

<p>In the above, we make sure that <code class="highlighter-rouge">makeSmashable(node, eventObject)</code> (a function we’ll implement now) gets run for all DOM nodes in the document.</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kr">const</span> <span class="nx">widEventMap</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Map</span><span class="p">();</span>

<span class="kd">function</span> <span class="nx">makeSmashable</span><span class="p">(</span><span class="nx">node</span><span class="p">,</span> <span class="nx">eventObject</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">node</span> <span class="k">instanceof</span> <span class="nx">HTMLDivElement</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">eventObject</span><span class="p">.</span><span class="nx">createEvent</span><span class="p">(</span><span class="s1">'smash'</span><span class="p">);</span>

    <span class="nb">Object</span><span class="p">.</span><span class="nx">defineProperty</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">webstrate</span><span class="p">,</span> <span class="s1">'smash'</span><span class="p">,</span> <span class="p">{</span>
      <span class="na">value</span><span class="p">:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">node</span><span class="p">.</span><span class="nx">webstrate</span><span class="p">.</span><span class="nx">signal</span><span class="p">(</span><span class="s1">'__smash'</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">});</span>

    <span class="nx">widEventMap</span><span class="p">.</span><span class="nx">set</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">webstrate</span><span class="p">.</span><span class="nx">id</span><span class="p">,</span> <span class="nx">eventObject</span><span class="p">);</span>
    <span class="nx">signaling</span><span class="p">.</span><span class="nx">subscribe</span><span class="p">(</span><span class="nx">node</span><span class="p">.</span><span class="nx">webstrate</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre>
</div>

<p>In the above, we check if our node is a <code class="highlighter-rouge">div</code> elemnt, and if so we create the <code class="highlighter-rouge">smash</code> event and define the <code class="highlighter-rouge">smash()</code> function.
The <code class="highlighter-rouge">smash</code> function simply sends a signal with the contents <code class="highlighter-rouge">__smash</code> on the node.
Lastly, we subscribe to signals on the node and create and populate a map (<code class="highlighter-rouge">widEventMap</code>) from the elements’ <code class="highlighter-rouge">__wids</code> to their respective event objects, which we will be using in the next and final part of our module.</p>

<div class="info box">
  <p>
    <strong>What are those <code>__wid</code>s?</strong> To keep better track of DOM, Webstrates
    adds unique IDs to each DOM elements. These are usually not visible in the DOM, even though they
    exist in the JsonML representation. While it should rarely be necessary for users to access
    the <code>__wid</code> of an element, it is available as <code>id</code> on all non-transient
    DOM nodes' webstrate objects (i.e. <code>DOMNode.webstrate.id</code>).
  </p>
  <p>
    If you want to know more about JsonML, check out
    <a href="/developerguide/how-it-works.html#jsonml">How it works</a> in the Developer guide.
  </p>
</div>

<p>In order to avoid signal event handlers getting triggered by our <code class="highlighter-rouge">smash</code> event, we install an interceptor on all signals.
The interceptor works by receiving all signals we’re subscribed to, and then returning <code class="highlighter-rouge">true</code> if the signal needs to be interceptor (i.e. not propagated further) or not.
If the interceptor returns a falsy value, the usual signaling related events (both system and userland) get triggered.</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="nx">signaling</span><span class="p">.</span><span class="nx">addInterceptor</span><span class="p">(</span><span class="nx">payload</span> <span class="o">=&gt;</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">payload</span><span class="p">.</span><span class="nx">m</span> <span class="o">!==</span> <span class="s1">'__smash'</span><span class="p">)</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>

  <span class="kr">const</span> <span class="nx">eventObject</span> <span class="o">=</span> <span class="nx">widEventMap</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="nx">payload</span><span class="p">.</span><span class="nx">id</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="nx">eventObject</span><span class="p">)</span> <span class="k">return</span> <span class="kc">false</span><span class="p">;</span>

  <span class="nx">eventObject</span><span class="p">.</span><span class="nx">triggerEvent</span><span class="p">(</span><span class="s1">'smash'</span><span class="p">,</span> <span class="nx">payload</span><span class="p">.</span><span class="nx">s</span><span class="p">);</span>
  <span class="k">return</span> <span class="kc">true</span><span class="p">;</span>
<span class="p">});</span>
</code></pre>
</div>

<p>In our interceptor, we access the raw payload object. This object contains a few pieces of information, such as the message itself (<code class="highlighter-rouge">payload.m</code>), the sender’s clientId <code class="highlighter-rouge">payload.s</code>, and the <code class="highlighter-rouge">__wid</code> of the element the signal was sent to (<code class="highlighter-rouge">payload.id</code>).
We first make sure that the signal received is in fact a smash, or otherwise return.
Afterwards, the map we created before comes into play. We look up the <code class="highlighter-rouge">__wid</code> in the map to find the event object associated with the node to whom the <code class="highlighter-rouge">__wid</code> belongs.
If we can’t find the event object, the shouldn’t intercept, either.
On the other hand, if we can find the event object, we trigger the event (with the sender’s clientId as argument) and return <code class="highlighter-rouge">true</code> to intercept the signal.</p>

<p>After it has been installed and enabled (as with the Party module), it can be used in a webstrate as below.</p>

<div class="language-html highlighter-rouge"><pre class="highlight"><code><span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;head&gt;</span>
  <span class="nt">&lt;script&gt;</span>
  <span class="nx">webstrate</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'loaded'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
    <span class="nb">Array</span><span class="p">.</span><span class="nx">from</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">querySelectorAll</span><span class="p">(</span><span class="s1">'div'</span><span class="p">),</span> <span class="nx">node</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="nx">node</span><span class="p">.</span><span class="nx">webstrate</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s1">'smash'</span><span class="p">,</span> <span class="nx">senderId</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="s1">'smash on'</span><span class="p">,</span> <span class="nx">node</span><span class="p">.</span><span class="nx">innerText</span><span class="p">);</span>
      <span class="p">});</span>

      <span class="nx">node</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="s1">'click'</span><span class="p">,</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">node</span><span class="p">.</span><span class="nx">webstrate</span><span class="p">.</span><span class="nx">smash</span><span class="p">();</span>
      <span class="p">});</span>
    <span class="p">});</span>
  <span class="p">});</span>
  <span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;/head&gt;</span>
<span class="nt">&lt;body&gt;</span>
  <span class="nt">&lt;div&gt;</span>A<span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;div&gt;</span>B<span class="nt">&lt;/div&gt;</span>
  <span class="nt">&lt;div&gt;</span>C<span class="nt">&lt;/div&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</code></pre>
</div>

<p>In the above webstrate, clicking on one of the <code class="highlighter-rouge">div</code>s will result in <code class="highlighter-rouge">smash on</code>, followed by either <code class="highlighter-rouge">A</code>, <code class="highlighter-rouge">B</code>, or <code class="highlighter-rouge">C</code> to be printed in the console of all connected clients.</p>



				<div>

					<div id="navigation"></div>
					<div id="disqus">
<div id="disqus_thread"></div>
<script type="text/javascript">
(function() {
	var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
	dsq.src = '//' + 'webstrates' + '.disqus.com/embed.js';
	(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);

	function waitForIframe(callback) {
		var iframe = 	document.querySelector('iframe[id^=dsq]');
		if (iframe) return callback(iframe);
		setTimeout(waitForIframe, 0, callback);
	}
	waitForIframe(function(iframe) {
		var scale = 0.88, width = 1/scale * 100, offset = (width - 100) / 2;
		iframe.setAttribute("style", `transform:scale(${scale});width:${width}%;margin-left:-${offset}%;`);
	});
})();
</script>
					</div>

				</div>


<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-104382751-1', 'auto');
ga('send', 'pageview');
</script>

			</div>
		</main>
		<footer>
			Documentation for <a href="https://github.com/Webstrates/Webstrates">Webstrates</a>
		</footer>
	</div>
</body>
</html>
