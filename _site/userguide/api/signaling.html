<!doctype html>
<html>
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<meta name="viewport" content="width=device-width, initial-scale=1">
	<title>Signaling | Webstrates</title>
	<meta name="description" content="A research prototype enabling collaborative editing of websites through DOM manipulations.">
	<link rel="stylesheet" href="/css/syntax.css">
	<link rel="stylesheet" href="/css/main.css">
</head>
<body>
	<div id="container">
		<header>
			<h1>
				<a class="brand" href="/">Webstrates</a>
				<small>A research prototype enabling collaborative editing of websites through DOM manipulations.</small>
			</h1>
		</header>
		<main>
			<div id="navigation">
				<ul class="nav nav-list">
					<li class="home"><a href="/">Home</a></li>
					<li>
						<a class="nav-header" href="">Getting started</a>
						<ul>
							<!--li><a href="/gettingstarted/motivation.html">Motivation</a></li-->
							<li><a href="/gettingstarted/installation.html">Installation</a></li>
							<li><a href="/gettingstarted/hello-world.html">Hello, world</a></li>
							<li><a href="/userguide/tutorials.html">Tutorials</a></li>
						</ul>
					</li>
					<li>
						<a class="nav-header" href="">User guide</a>
						<ul>
							<li><a href="/userguide/api.html">API</a></li>
							<li>
								<ul>
									<li><a href="/userguide/api/events.html">Events</a></li>
									<li><a href="/userguide/api/transient.html">Transient</a></li>
									<li><a href="/userguide/api/cookies.html">Cookies</a></li>
									<li><a href="/userguide/api/assets.html">Assets</a></li>
									<li><a class="active" href="/userguide/api/signaling.html">Signaling</a></li>
									<li><a href="/userguide/api/messaging.html">Messaging</a></li>
									<li><a href="/userguide/api/tagging.html">Tagging</a></li>
									<li><a href="/userguide/api/access-tokens.html">Access Tokens</a></li>
									<li><a href="/userguide/api/restore-delete.html">Restore/Delete</a></li>
								</ul>
							</li>
							<li><a href="/userguide/http-api.html">HTTP API</a></li>
							<li><a href="/userguide/server-config.html">Server Config</a></li>
							<li><a href="/userguide/client-config.html">Client Config</a></li>
							<li><a href="/userguide/versioning.html">Versioning</a></li>
						</ul>
					</li>
					<li>
						<a class="nav-header" href="">Developer guide</a>
						<ul>
							<li><a href="/developerguide/introduction.html">Introduction</a></li>
							<li><a href="/developerguide/how-it-works.html">How it works</a></li>
							<li><a href="/developerguide/creating-a-module.html">Creating a module</a></li>
						</ul>
					</li>
				</ul>
			</div>
			<div id="content">
				<div class="page-header">
					<h1>Signaling
						
					</h1>
				</div>
				<ul id="markdown-toc">
  <li><a href="#signaling-on-user-object" id="markdown-toc-signaling-on-user-object">Signaling on user object</a></li>
  <li><a href="#signal-streaming" id="markdown-toc-signal-streaming">Signal streaming</a>    <ul>
      <li><a href="#terminating-streams" id="markdown-toc-terminating-streams">Terminating streams</a></li>
      <li><a href="#stream-types" id="markdown-toc-stream-types">Stream types</a></li>
    </ul>
  </li>
</ul>

<p>Subscribe to signals on DOM elements and receive messages from other clients sending signals on the DOM element. Useful especially for huge amounts of data that will be expensive to continuously publish through the DOM (e.g. sensor data).</p>

<p>Listen for messages on <code class="highlighter-rouge">elementNode</code>:</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="nx">elementNode</span><span class="p">.</span><span class="nx">webstrate</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">"signal"</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="nx">senderId</span><span class="p">,</span> <span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Received message from senderId on node.</span>
<span class="p">});</span>
</code></pre>
</div>

<p><code class="highlighter-rouge">node</code> will always equal <code class="highlighter-rouge">elementNode</code>, but may be useful if the node is no longer in scope.</p>

<p>Send messages on <code class="highlighter-rouge">elementNode</code>:</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="nx">elementNode</span><span class="p">.</span><span class="nx">webstrate</span><span class="p">.</span><span class="nx">signal</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="p">[</span><span class="nx">recipients</span><span class="p">]);</span>
</code></pre>
</div>

<p>An optional array of Client IDs (<code class="highlighter-rouge">recipients</code>) can be passed in. If recipients is not defined, all subscribers will recieve the message, otherwise only the clients in <code class="highlighter-rouge">recipients</code> will. Recipients are never aware of who else has received the signal.</p>

<p>Instead of listening for specific signals on DOM nodes, it is also possible to listen for all events using the webstrate instance.</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="nx">webstrate</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">"signal"</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="nx">senderId</span><span class="p">,</span> <span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">node</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Signal sent on node.</span>
  <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
    <span class="c1">// Signal sent on webstrate instance.</span>
  <span class="p">}</span>
<span class="p">});</span>
</code></pre>
</div>

<p>If the signal was sent on the webstrate instance (<code class="highlighter-rouge">webstrate.signal(message, [recipients])</code>), <code class="highlighter-rouge">node</code> will be undefined, otherwise <code class="highlighter-rouge">node</code> will be the DOM element the signal was sent on.</p>

<p>Listening on the webstrate instance does not circumvent the recipients mechanism – subscribers will still not recieve signals specifically addressed to other clients.</p>

<h3 id="signaling-on-user-object">Signaling on user object</h3>

<p>In addition to signaling on DOM elements, it is also possible to signal on the user object, allowing users to send signals/messages to any of the user’s other connected clients across different webstrates:</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="nx">webstrate</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">"signal"</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">message</span><span class="p">,</span> <span class="nx">senderId</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// A message was received from client with senderId.</span>
<span class="p">));</span>
</code></pre>
</div>

<p>When sending a signal, no <code class="highlighter-rouge">recipients</code> are specified, because all user object signals automatically are sent to all connected clients, regardless of which webstrate the client is connected to.</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="nx">webstrate</span><span class="p">.</span><span class="nx">user</span><span class="p">.</span><span class="nx">signal</span><span class="p">(</span><span class="nx">message</span><span class="p">);</span>
</code></pre>
</div>
<h2 id="signal-streaming">Signal streaming</h2>

<p>Webstrates supports WebRTC-based signaling streaming, allowing users to stream to each other through nodes directly (peer-to-peer).</p>

<p>A user may start listening for users interested in receiving a stream on a node using:</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="nx">elementNode</span><span class="p">.</span><span class="nx">webstrate</span><span class="p">.</span><span class="nx">signalStream</span><span class="p">(</span><span class="kd">function</span> <span class="nx">signalStream</span><span class="p">(</span><span class="nx">clientId</span><span class="p">,</span> <span class="nx">accept</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// User with clientId is listening for streams on elementNode.</span>
<span class="p">});</span>
</code></pre>
</div>

<p>If the user agrees to let clientId receive a stream, the user calls the accept callback provided as the second argument with the stream as well meta data (any serializable object), and an optional callback that’ll be called once the connection has been established. The accept function returns a connection object.</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="nx">elementNode</span><span class="p">.</span><span class="nx">webstrate</span><span class="p">.</span><span class="nx">signalStream</span><span class="p">(</span><span class="kd">function</span> <span class="nx">signalStream</span><span class="p">(</span><span class="nx">clientId</span><span class="p">,</span> <span class="nx">accept</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">conn</span> <span class="o">=</span> <span class="nx">accept</span><span class="p">(</span><span class="nx">stream</span><span class="p">,</span> <span class="nx">meta</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// Connection has been established.</span>
  <span class="p">});</span>
<span class="p">});</span>
</code></pre>
</div>

<p>Listening for streams on a node is done using:</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="nx">elementNode</span><span class="p">.</span><span class="nx">webstrate</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">"signalStream"</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">onSignalStream</span><span class="p">(</span><span class="nx">clientId</span><span class="p">,</span> <span class="nx">meta</span><span class="p">,</span> <span class="nx">accept</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// User with clientId is requesting to send a stream.</span>
<span class="p">});</span>
</code></pre>
</div>

<p>If the user wants to accept the stream, the connect function is called with a callback that will be triggered once the stream is ready:</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="nx">elementNode</span><span class="p">.</span><span class="nx">webstrate</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">"signalStream"</span><span class="p">,</span> <span class="kd">function</span><span class="p">(</span><span class="nx">onSignalStream</span><span class="p">(</span><span class="nx">clientId</span><span class="p">,</span> <span class="nx">meta</span><span class="p">,</span> <span class="nx">accept</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">conn</span> <span class="o">=</span> <span class="nx">accept</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">stream</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Stream received.</span>
  <span class="p">});</span>
<span class="p">});</span>
</code></pre>
</div>

<p>If either user does not want to initiate the connection, they simply abstrain from calling the <code class="highlighter-rouge">accept</code> callback.</p>

<h3 id="terminating-streams">Terminating streams</h3>

<p>Either user can at any time terminate the stream by calling <code class="highlighter-rouge">conn.close()</code>. If a connection is terminated, the other user will get notified if they have added an <code class="highlighter-rouge">onclose</code> callback to the connection object:</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="nx">conn</span><span class="p">.</span><span class="nx">onclose</span><span class="p">(</span><span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// Connection was terminated.</span>
<span class="p">});</span>
</code></pre>
</div>

<p>To stop listening for clients listening for streams, the streaming client may do:</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="nx">elementNode</span><span class="p">.</span><span class="nx">webstrate</span><span class="p">.</span><span class="nx">signalStream</span><span class="p">(</span><span class="kd">function</span> <span class="nx">signalStream</span><span class="p">(</span><span class="nx">clientId</span><span class="p">,</span> <span class="nx">accept</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">conn</span> <span class="o">=</span> <span class="nx">accept</span><span class="p">(</span><span class="nx">stream</span><span class="p">,</span> <span class="nx">meta</span><span class="p">,</span> <span class="kd">function</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// No longer accepting requests to receive the stream.</span>
    <span class="nx">elementNode</span><span class="p">.</span><span class="nx">webstrate</span><span class="p">.</span><span class="nx">stopStreamSignal</span><span class="p">(</span><span class="nx">signalStream</span><span class="p">);</span>
  <span class="p">});</span>
<span class="p">});</span>
</code></pre>
</div>

<p>The already established connections will not be terminated, but no new requests will be received. Note that <code class="highlighter-rouge">stopStreamSignal</code> has to be called <em>after</em> the connection to the client has been established, otherwiser the connection will never finish getting established.</p>

<p>Clients listening for streams do not have to stop listening for new requests. Once one signal stream has been established, the client will automatically stop listening for additional streams. If the client wants to receive multiple streams, it can simply start listening for streams on the node again.</p>

<h3 id="stream-types">Stream types</h3>

<p>The signal streaming can carry any <a href="https://developer.mozilla.org/en-US/docs/Web/API/MediaStream"><code class="highlighter-rouge">MediaStream</code></a> object, for instance a video and audio feed:</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="nx">elementNode</span><span class="p">.</span><span class="nx">webstrate</span><span class="p">.</span><span class="nx">signalStream</span><span class="p">(</span><span class="kd">function</span> <span class="nx">signalStream</span><span class="p">(</span><span class="nx">clientId</span><span class="p">,</span> <span class="nx">accept</span><span class="p">)</span> <span class="p">{</span>
  <span class="c1">// Get audio and video feed.</span>
  <span class="nx">navigator</span><span class="p">.</span><span class="nx">mediaDevices</span><span class="p">.</span><span class="nx">getUserMedia</span><span class="p">({</span> <span class="na">audio</span><span class="p">:</span> <span class="kc">true</span><span class="p">,</span> <span class="na">video</span><span class="p">:</span> <span class="kc">true</span> <span class="p">}).</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">stream</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// And send it to the requesting client.</span>
    <span class="kd">var</span> <span class="nx">meta</span> <span class="o">=</span> <span class="p">{</span> <span class="na">title</span><span class="p">:</span> <span class="s2">"My Video Stream"</span> <span class="p">};</span>
    <span class="kd">var</span> <span class="nx">conn</span> <span class="o">=</span> <span class="nx">accept</span><span class="p">(</span><span class="nx">stream</span><span class="p">,</span> <span class="nx">meta</span><span class="p">,</span> <span class="p">...);</span>
  <span class="p">});</span>
<span class="p">});</span>
</code></pre>
</div>

<p>The stream received (in this example) can then be added to a <code class="highlighter-rouge">&lt;video&gt;</code> element in the DOM.</p>

<div class="language-javascript highlighter-rouge"><pre class="highlight"><code><span class="kd">var</span> <span class="nx">videoElement</span> <span class="o">=</span> <span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s2">"video"</span><span class="p">);</span>
<span class="nb">document</span><span class="p">.</span><span class="nx">body</span><span class="p">.</span><span class="nx">appendChild</span><span class="p">(</span><span class="nx">videoElement</span><span class="p">);</span>
<span class="nx">elementNode</span><span class="p">.</span><span class="nx">webstrate</span><span class="p">.</span><span class="nx">on</span><span class="p">(</span><span class="s2">"signalStream"</span><span class="p">,</span> <span class="kd">function</span> <span class="nx">onSignalStream</span><span class="p">(</span><span class="nx">clientId</span><span class="p">,</span> <span class="nx">meta</span><span class="p">,</span> <span class="nx">accept</span><span class="p">)</span> <span class="p">{</span>
  <span class="kd">var</span> <span class="nx">conn</span> <span class="o">=</span> <span class="nx">accept</span><span class="p">(</span><span class="kd">function</span><span class="p">(</span><span class="nx">stream</span><span class="p">)</span> <span class="p">{</span>
    <span class="c1">// Add stream to video element and play it.</span>
    <span class="nx">videoElement</span><span class="p">.</span><span class="nx">srcObject</span> <span class="o">=</span> <span class="nx">stream</span><span class="p">;</span>
    <span class="nx">videoElement</span><span class="p">.</span><span class="nx">play</span><span class="p">();</span>
  <span class="p">});</span>
<span class="p">});</span>
</code></pre>
</div>



				<div>

					<div id="navigation"></div>
					<div id="disqus">
<div id="disqus_thread"></div>
<script type="text/javascript">
(function() {
	var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
	dsq.src = '//' + 'webstrates' + '.disqus.com/embed.js';
	(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);

	function waitForIframe(callback) {
		var iframe = 	document.querySelector('iframe[id^=dsq]');
		if (iframe) return callback(iframe);
		setTimeout(waitForIframe, 0, callback);
	}
	waitForIframe(function(iframe) {
		var scale = 0.88, width = 1/scale * 100, offset = (width - 100) / 2;
		iframe.setAttribute("style", `transform:scale(${scale});width:${width}%;margin-left:-${offset}%;`);
	});
})();
</script>
					</div>

				</div>


<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','//www.google-analytics.com/analytics.js','ga');
ga('create', 'UA-104382751-1', 'auto');
ga('send', 'pageview');
</script>

			</div>
		</main>
		<footer>
			Documentation for <a href="https://github.com/Webstrates/Webstrates">Webstrates</a>
		</footer>
	</div>
</body>
</html>
